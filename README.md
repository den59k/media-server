# Рабочая версия медиасервера

## Стек

Приложение построено на основе библиотеки MediaSoup. 

Для запуска потребуется выполнить все пункты из этой инструкции: <https://mediasoup.org/documentation/v3/mediasoup/installation/>

## Основные API для работы:

При помощи команд ниже можно организовать подключение 2х или более пользователей.

### Создание комнаты: 
```POST /rooms```

```
Возвращает:
{
  room_id: string
}
```

### Добавление пользователя в комнату
```POST /rooms/:room_id/users/:user_id```, где *:room_id* - ID комнаты, а *:user_id* - ID пользователя 
(ID пользователя генерируется самим бекэнд-сервером заранее, и должно быть уникально для каждого подключения)

```
Возвращает:
{
  offer: SDP,
}
```

### Начало вещания пользователем
```POST /rooms/:room_id/users/:user_id/produce```

```
body:
{
  offer: SDP
}

Возвращает:
{
  answer: SDP,
  outbound: Array<{
    id: string,
    offer: SDP
  }>
}
```

### Подтверждение подключения пользователя
```POST /rooms/:room_id/users/:user_id/consume```

```
body: 
{
  answer: SDP
}
```

### Удаление комнаты:
```DELETE /rooms/:room_id```

*Пока не реализовано*

### Удаление пользователя из комнаты:
```DELETE /rooms/:room_id/users/:user_id```

*Пока не реализовано*

## Запуск через Docker

Чтобы собрать контейнер необходимо выполнить команду  
```
docker build -t mediasoup .
```

Собранный контейнер можно запустить со следующими переменными среды:

* PORT=5000 - порт для самого приложения
* ADDRESS=0.0.0.0 - IP адрес для запускаемого приложения. Для запуска в Docker используется не localhost, а именно 0.0.0.0.
* PUBLIC_IP=192.168.0.100 - *внешний* IP адрес сервера. Используется для RTC подключения по UDP/TCP соединению
* RTC_MIN_PORT=10000 - Минимальный RTC порт для ICE, DTLS, RTP, и т.д.
* RTC_MAX_PORT=59999 - Максимальный RTC порт для ICE, DTLS, RTP, и т.д.
 
Например, для запуска контейнера с UDP портами на 10000-10009 необходимо выполнить команду
```
docker run -d -p 5000:5000 -p 10000-10009:10000-10009 -e "RTC_MAX_PORT=10009" mediasoup
```

Для того, чтобы устройства смогли подключиться к указанным портам между RTC_MIN_PORT и RTC_MAX_PORT, 
необходимо пробросить указанные порты в самой ОС, или указать в PUBLIC_IP IP-адрес Docker.